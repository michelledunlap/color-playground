<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HSL Color Graph</title>
    <style>
        body {
            margin: 0; overflow: hidden;
            font-family: 'Courier New', Courier, monospace;
            cursor: none; background-color: #222; color: white;
            user-select: none;
        }

        /* --- AXES --- */
        .axis-y {
            position: fixed; left: 0; top: 0; bottom: 50px; width: 20px;
            background: linear-gradient(to bottom, white, black);
            z-index: 2; border-right: 1px solid rgba(255,255,255,0.3);
        }
        .axis-x {
            position: fixed; left: 20px; right: 0; bottom: 50px; height: 20px;
            background: linear-gradient(to right, 
                hsl(0, 100%, 50%), hsl(60, 100%, 50%), hsl(120, 100%, 50%), 
                hsl(180, 100%, 50%), hsl(240, 100%, 50%), hsl(300, 100%, 50%), 
                hsl(360, 100%, 50%)
            );
            z-index: 2; border-top: 1px solid rgba(255,255,255,0.3);
        }

        /* --- UI ELEMENTS --- */
        #command-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 50px;
            background: #000; border-top: 1px solid #444;
            display: flex; align-items: center; padding-left: 20px;
            box-sizing: border-box; z-index: 100; cursor: text;
            transition: background-color 0.2s;
        }
        #cmd-prefix { color: #00ffcc; margin-right: 10px; font-weight: bold; }
        #cmd-input {
            background: transparent; border: none; color: white;
            font-family: 'Courier New', Courier, monospace; font-size: 16px;
            width: 100%; outline: none; text-transform: lowercase;
        }

        #hud {
            position: fixed; top: 20px; right: 20px; text-align: right;
            pointer-events: none; color: rgba(255,255,255,0.7); z-index: 10;
        }

        /* --- HELP MODAL --- */
        #help-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            align-items: center; justify-content: center;
        }
        #help-modal.open { display: flex; cursor: default; }
        
        .modal-content {
            background: #111; border: 1px solid #00ffcc;
            padding: 30px; border-radius: 8px; max-width: 500px;
            box-shadow: 0 0 20px rgba(0, 255, 204, 0.2);
            color: #ccc; line-height: 1.6;
        }
        .modal-content h2 { color: #00ffcc; margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 10px; }
        .key { display: inline-block; background: #333; padding: 2px 6px; border-radius: 4px; color: white; font-size: 0.9em; border: 1px solid #555; }
        .close-btn { float: right; cursor: pointer; color: #666; font-weight: bold; font-size: 20px; }
        .close-btn:hover { color: white; }

        /* --- GRID & CURSOR --- */
        .grid {
            position: absolute; top: 0; left: 20px; right: 0; bottom: 70px;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none;
        }
        .hair-x { position: fixed; left: 20px; right: 0; height: 1px; background: rgba(255,255,255,0.4); pointer-events: none; z-index: 5; }
        .hair-y { position: fixed; top: 0; bottom: 70px; width: 1px; background: rgba(255,255,255,0.4); pointer-events: none; z-index: 5; }

        /* --- STAMPS & SELECTION --- */
        .stamp {
            position: absolute; width: 40px; height: 40px;
            border-radius: 50%; border: 2px solid white;
            transform: translate(-50%, -50%); z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer; pointer-events: auto;
        }
        .stamp.pop { transform: translate(-50%, -50%) scale(1.5); }
        
        /* SELECTION: White + Black Double Border for High Contrast */
        .stamp.selected {
            border: 2px solid white;
            box-shadow: 0 0 0 2px black, 0 0 15px rgba(255,255,255,0.5);
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 20;
        }

        .stamp:hover::after {
            content: attr(data-hex);
            position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.9); color: #00ffcc;
            padding: 5px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;
            border: 1px solid #00ffcc; white-space: nowrap; z-index: 30;
            pointer-events: none;
        }
    </style>
</head>
<body>

    <div id="help-modal">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleHelp()">×</span>
            <h2>COMMAND MANUAL</h2>
            <p><strong>Explore:</strong> Move mouse to change color.</p>
            <p><strong>Stamp:</strong> Click or press <span class="key">Space</span></p>
            <p><strong>Shortcuts:</strong></p>
            <ul>
                <li><span class="key">Ctrl</span> + <span class="key">Z</span> : Undo</li>
                <li><span class="key">Ctrl</span> + <span class="key">Y</span> : Redo</li>
                <li><span class="key">Ctrl</span> + <span class="key">A</span> : Select All</li>
                <li><span class="key">Del</span> : Delete Selected</li>
            </ul>
            <p><strong>Commands:</strong> Type <span class="key">export</span>, <span class="key">missed</span>, or vibes like <span class="key">neon</span>, <span class="key">snake</span>, or <span class="key">reef</span>.</p>
            <p style="text-align: center; margin-top: 20px; font-size: 0.8em; color: #666;">
                [Press Enter, Esc, or Backspace to close]
            </p>
        </div>
    </div>

    <div class="axis-y"></div>
    <div class="axis-x"></div>
    <div class="grid"></div>

    <div id="hud">
        HUE <span id="val-hue">0</span>°<br>LGT <span id="val-light">50</span>%<br>SAT <span id="val-sat">100</span>%
    </div>

    <div class="hair-x"></div>
    <div class="hair-y"></div>

    <div id="command-bar" onclick="document.getElementById('cmd-input').focus()">
        <span id="cmd-prefix">user@colors:~$</span>
        <input id="cmd-input" type="text" autocomplete="off">
    </div>

    <script>
        // --- DATA: SYNONYM MAP ---
        const SYNONYMS = {
            // NATURE
            'forest': 'forest', 'tree': 'forest', 'fern': 'forest', 'moss': 'forest', 'jungle': 'forest', 'pine': 'forest',
            'ocean': 'water', 'sea': 'water', 'rain': 'water', 'water': 'water', 'lake': 'water', 'pool': 'water',
            'fire': 'fire', 'flame': 'fire', 'burn': 'fire', 'hot': 'fire', 'magma': 'fire',
            'ice': 'ice', 'snow': 'ice', 'glacier': 'ice', 'frozen': 'ice', 'cold': 'ice',
            'sunset': 'sunset', 'dusk': 'sunset', 'dawn': 'sunset', 'sunrise': 'sunset', 'horizon': 'sunset',
            'midnight': 'night', 'night': 'night', 'dark': 'night', 'moon': 'night', 'space': 'night',
            
            // REPTILES (Snake)
            'snake': 'reptile', 'lizard': 'reptile', 'turtle': 'reptile', 'alligator': 'reptile', 'croc': 'reptile', 'reptile': 'reptile', 'dragon': 'reptile',
            
            // ARCHITECTURE (House)
            'house': 'house', 'home': 'house', 'brick': 'house', 'city': 'house', 'building': 'house', 'cottage': 'house',

            // CORAL REEF (Reef)
            'reef': 'coral', 'coral': 'coral', 'sponge': 'coral', 'anemone': 'coral', 'scuba': 'coral',

            // FOOD
            'lemon': 'citrus', 'lime': 'citrus', 'citrus': 'citrus', 'sour': 'citrus', 'fruit': 'citrus',
            'berry': 'berry', 'strawberry': 'berry', 'raspberry': 'berry', 'jam': 'berry',
            'wine': 'wine', 'merlot': 'wine', 'grape': 'wine', 'burgundy': 'wine',
            'candy': 'candy', 'sweet': 'candy', 'bubblegum': 'candy', 'pink': 'candy',
            'chocolate': 'choco', 'coffee': 'choco', 'brown': 'choco', 'latte': 'choco', 'mocha': 'choco',
            
            // ELEMENTS
            'gold': 'gold', 'golden': 'gold', 'honey': 'gold', 'brass': 'gold',
            'silver': 'silver', 'metal': 'silver', 'steel': 'silver', 'grey': 'silver', 'gray': 'silver',
            'rust': 'rust', 'orange': 'rust', 'clay': 'rust', 'mars': 'rust',
            
            // EMOTIONS
            'royal': 'royal', 'king': 'royal', 'purple': 'royal', 'majestic': 'royal',
            'angry': 'fire', 'rage': 'fire', 'danger': 'fire',
            'sad': 'sad', 'blues': 'sad', 'gloom': 'sad', 'rainy': 'sad',
            'happy': 'citrus', 'joy': 'citrus',
            'calm': 'water', 'peace': 'water',
            'love': 'love', 'romance': 'love', 'valentine': 'love', 'rose': 'love', 'heart': 'love',
            'retro': 'retro', 'vintage': 'retro', '70s': 'retro', 'nostalgia': 'retro',
            
            // SPECIFIC OVERRIDES
            'starfish': 'starfish' 
        };

        function hslToHex(h, s, l) {
            l /= 100; const a = s * Math.min(l, 1 - l) / 100;
            const f = n => {
                const k = (n + h / 30) % 12;
                const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
                return Math.round(255 * color).toString(16).padStart(2, '0');
            };
            return `#${f(0)}${f(8)}${f(4)}`;
        }

        // --- MISSED TERM TRACKER ---
        const missedTerms = [];

        // --- VIBE LOGIC ---
        function getColorsFromVibe(rawTerm) {
            let term = rawTerm;
            
            // PLURAL HANDLER (Stemmer)
            if (term.endsWith('s') && !SYNONYMS[term]) {
                const singular = term.slice(0, -1);
                if (SYNONYMS[singular] || singular.match(/fish|shark|whale|dog|cat|bear|wolf|fox|synth|cyber|neon|pastel|xmas|christmas|halloween/)) {
                    term = singular;
                }
            }

            let category = SYNONYMS[term];

            // Fallback Logic
            if (!category) {
                if (term === 'starfish') category = 'starfish';
                else if (term.match(/fish|shark|whale/)) category = 'water';
                else if (term.match(/dog|cat|bear|wolf|fox/)) category = 'animal';
                else if (term.match(/synth|cyber|neon/)) category = 'neon';
                else if (term.match(/pastel|baby/)) category = 'pastel';
                else if (term.match(/xmas|christmas/)) category = 'xmas';
                else if (term.match(/halloween/)) category = 'halloween';
            }

            const colors = [];
            const count = 5; 
            const add = (hMin, hMax, sMin, sMax, lMin, lMax) => {
                const h = Math.floor(Math.random() * (hMax - hMin + 1)) + hMin;
                const s = Math.floor(Math.random() * (sMax - sMin + 1)) + sMin;
                const l = Math.floor(Math.random() * (lMax - lMin + 1)) + lMin;
                colors.push({h, s, l});
            };

            switch(category) {
                case 'forest': for(let i=0; i<count; i++) add(80, 150, 30, 70, 20, 50); break;
                case 'water': for(let i=0; i<count; i++) add(170, 240, 50, 90, 40, 80); break;
                case 'fire': for(let i=0; i<count; i++) add(0, 40, 70, 100, 40, 60); break;
                case 'ice': for(let i=0; i<count; i++) add(180, 210, 20, 50, 80, 95); break;
                case 'night': for(let i=0; i<count; i++) add(220, 280, 60, 100, 5, 25); break;
                case 'sunset': add(280, 320, 50, 80, 30, 50); add(330, 360, 60, 90, 50, 70); add(10, 40, 70, 100, 50, 60); add(40, 60, 80, 100, 50, 70); break;
                case 'citrus': for(let i=0; i<count; i++) add(40, 65, 80, 100, 50, 70); break;
                case 'berry': for(let i=0; i<count; i++) add(320, 350, 60, 90, 40, 70); break;
                case 'wine': for(let i=0; i<count; i++) add(330, 360, 40, 70, 15, 35); break;
                case 'candy': for(let i=0; i<count; i++) add(300, 350, 80, 100, 70, 85); break;
                case 'choco': for(let i=0; i<count; i++) add(15, 35, 40, 70, 15, 40); break;
                case 'gold': for(let i=0; i<count; i++) add(40, 55, 70, 100, 40, 70); break;
                case 'silver': for(let i=0; i<count; i++) add(200, 220, 0, 15, 40, 80); break;
                case 'rust': for(let i=0; i<count; i++) add(10, 30, 40, 70, 30, 50); break;
                case 'royal': for(let i=0; i<count; i++) add(260, 290, 60, 100, 30, 50); break;
                case 'love': for(let i=0; i<count; i++) add(330, 360, 60, 100, 40, 80); break;
                case 'sad': for(let i=0; i<count; i++) add(200, 240, 10, 40, 30, 50); break;
                case 'retro': add(30, 50, 60, 90, 50, 70); add(10, 30, 60, 90, 40, 60); add(60, 90, 40, 70, 30, 50); add(160, 190, 30, 60, 40, 60); break;
                case 'animal': for(let i=0; i<count; i++) add(20, 40, 20, 60, 30, 70); break;
                case 'neon': for(let i=0; i<count; i++) add(0, 360, 90, 100, 50, 60); break;
                case 'pastel': for(let i=0; i<count; i++) add(0, 360, 30, 60, 80, 95); break;
                case 'xmas': add(350, 360, 80, 100, 40, 60); add(120, 150, 60, 90, 30, 50); break;
                case 'halloween': add(20, 40, 90, 100, 40, 60); add(270, 280, 60, 90, 20, 40); break;
                
                case 'starfish': add(330, 360, 60, 90, 60, 80); add(10, 30, 70, 100, 50, 70); add(0, 15, 60, 80, 60, 80); break;
                case 'reptile': add(70, 140, 30, 60, 25, 45); add(30, 50, 40, 60, 30, 50); break;
                case 'house': add(0, 20, 30, 50, 40, 60); add(200, 220, 0, 10, 50, 80); add(30, 50, 20, 40, 80, 95); break;
                case 'coral': add(320, 350, 70, 100, 50, 70); add(10, 30, 80, 100, 50, 70); add(170, 190, 60, 90, 40, 60); break;

                default: return null;
            }
            return colors;
        }

        // --- MAIN STATE ---
        let hue = 180, sat = 100, light = 50;
        let isAutoPlaying = false; 
        const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, Space: false };
        let lastStampPos = { x: -999, y: -999 };
        const stampHistory = [];
        const redoStack = [];

        const hairX = document.querySelector('.hair-x');
        const hairY = document.querySelector('.hair-y');
        const cmdInput = document.getElementById('cmd-input');
        const modal = document.getElementById('help-modal');
        const offsetLeft = 20; const offsetBottom = 50; 

        const placeholders = [
            "try 'snake', 'house', or 'reef'...",
            "try 'retro', 'gold', or 'love'...",
            "type 'help' for manual...",
            "type 'missed' to see what failed..."
        ];
        cmdInput.placeholder = placeholders[Math.floor(Math.random() * placeholders.length)];

        function getDims() { return { w: window.innerWidth - offsetLeft, h: window.innerHeight - offsetBottom }; }
        function dataToPos(h, l) {
            const dims = getDims();
            return { x: offsetLeft + ((h / 360) * dims.w), y: ((100 - l) / 100) * dims.h };
        }

        function render() {
            document.body.style.backgroundColor = `hsl(${hue}, ${sat}%, ${light}%)`;
            document.getElementById('val-hue').innerText = Math.round(hue);
            document.getElementById('val-light').innerText = Math.round(light);
            document.getElementById('val-sat').innerText = Math.round(sat);
            const pos = dataToPos(hue, light);
            hairX.style.top = pos.y + 'px';
            hairY.style.left = pos.x + 'px';
        }

        function updateLoop() {
            if (isAutoPlaying) { requestAnimationFrame(updateLoop); return; }
            const step = 2;
            if (keys.ArrowRight) hue = (hue + step) % 360;
            if (keys.ArrowLeft) hue = (hue - step + 360) % 360;
            if (keys.ArrowUp) light = Math.min(100, light + step);
            if (keys.ArrowDown) light = Math.max(0, light - step);

            if (keys.Space) {
                const currentPos = dataToPos(hue, light);
                const dx = currentPos.x - lastStampPos.x;
                const dy = currentPos.y - lastStampPos.y;
                if (Math.sqrt(dx*dx + dy*dy) > 30) {
                    createStamp(hue, light, sat);
                    lastStampPos = { x: currentPos.x, y: currentPos.y };
                }
            }
            render();
            requestAnimationFrame(updateLoop);
        }
        requestAnimationFrame(updateLoop);

        // --- INPUT HANDLING ---
        document.addEventListener('keydown', (e) => {
            const cmd = e.metaKey || e.ctrlKey;
            
            // Shortcuts
            if (cmd && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undoStamp(); return; }
            if ((cmd && e.shiftKey && e.key === 'z') || (cmd && e.key === 'y')) { e.preventDefault(); redoStamp(); return; }
            if (cmd && e.key === 'a') {
                e.preventDefault();
                document.querySelectorAll('.stamp').forEach(s => s.classList.add('selected'));
                return;
            }
            if (e.key === '?' && document.activeElement !== cmdInput) { toggleHelp(); return; }
            
            // Modal Logic (Enter/Esc/Delete/Backspace to Close)
            if (modal.classList.contains('open')) {
                if (['Enter', 'Escape', 'Backspace', 'Delete'].includes(e.key)) {
                    toggleHelp();
                }
                return;
            }

            // Global Esc Logic
            if (e.key === 'Escape') {
                // If typing, blur input to return to canvas control
                if (document.activeElement === cmdInput) {
                    cmdInput.blur();
                    return;
                }
                document.querySelectorAll('.stamp.selected').forEach(s => s.classList.remove('selected'));
                return;
            }

            if (document.activeElement === cmdInput) return;

            // Deletion
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const selected = document.querySelectorAll('.stamp.selected');
                if (selected.length > 0) {
                    selected.forEach(s => s.remove());
                    return; 
                }
                undoStamp(); 
                return;
            }

            if (keys.hasOwnProperty(e.code) || e.code === "Space") keys[e.code] = true;
        });

        document.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.code) || e.code === "Space") keys[e.code] = false;
        });
        document.addEventListener('mousemove', (e) => {
            if(isAutoPlaying) return; 
            const dims = getDims();
            hue = Math.max(0, Math.min(360, ((e.clientX - offsetLeft) / dims.w) * 360));
            light = Math.max(0, Math.min(100, (1 - (e.clientY / dims.h)) * 100));
        });
        document.addEventListener('wheel', (e) => {
            sat = e.deltaY > 0 ? Math.max(0, sat - 5) : Math.min(100, sat + 5);
        });
        
        // --- CLICK LOGIC ---
        document.addEventListener('click', (e) => {
            if (e.target.closest('#command-bar') || e.target.closest('#help-modal')) return;
            if (modal.classList.contains('open')) { toggleHelp(); return; }

            if (e.target.classList.contains('stamp')) {
                if (e.metaKey || e.ctrlKey) {
                    e.target.classList.toggle('selected');
                } else {
                    if (e.target.classList.contains('selected')) {
                        e.target.classList.remove('selected');
                    } else {
                        document.querySelectorAll('.stamp.selected').forEach(s => s.classList.remove('selected'));
                        e.target.classList.add('selected');
                    }
                }
                return;
            }

            document.querySelectorAll('.stamp.selected').forEach(s => s.classList.remove('selected'));
            createStamp(hue, light, sat);
            const pos = dataToPos(hue, light);
            lastStampPos = { x: pos.x, y: pos.y };
        });

        // --- COMMAND BAR LOGIC ---
        cmdInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.stopPropagation(); // Stop bubbling so global handler doesn't auto-close help
                
                const query = cmdInput.value.toLowerCase().trim();
                const bar = document.getElementById('command-bar');
                
                if (query === 'clear' || query === 'reset') {
                    document.querySelectorAll('.stamp').forEach(el => el.remove());
                    stampHistory.length = 0; 
                    redoStack.length = 0;
                    document.querySelectorAll('.stamp.selected').forEach(s => s.classList.remove('selected'));
                } 
                else if (query === 'export' || query === 'save' || query === 'copy') {
                    exportColors();
                }
                else if (query === 'help') {
                    toggleHelp();
                }
                else if (query === 'missed') {
                    if (missedTerms.length > 0) {
                        alert("Your session's missing words:\n- " + missedTerms.join("\n- "));
                    } else {
                        alert("No missing words yet!");
                    }
                }
                else {
                    const colors = getColorsFromVibe(query); 
                    if (colors) {
                        playPalette(colors);
                    } else {
                        if (!missedTerms.includes(query)) {
                            missedTerms.push(query);
                            console.log("Missed term logged:", query);
                        }
                        bar.style.backgroundColor = '#522';
                        setTimeout(() => bar.style.backgroundColor = '#000', 200);
                    }
                }
                cmdInput.value = ""; 
                // REMOVED cmdInput.blur() to allow rapid firing
            }
        });

        // --- UTILS ---
        function toggleHelp() {
            modal.classList.toggle('open');
            if(modal.classList.contains('open')) document.activeElement.blur();
        }

        function createStamp(h, l, s) {
            redoStack.length = 0;
            const stamp = document.createElement('div');
            stamp.classList.add('stamp');
            const pos = dataToPos(h, l);
            stamp.style.left = pos.x + 'px'; stamp.style.top = pos.y + 'px';
            stamp.style.backgroundColor = `hsl(${h}, ${s}%, ${l}%)`;
            const hex = hslToHex(h, s, l);
            stamp.setAttribute('data-hex', hex);
            document.body.appendChild(stamp);
            stampHistory.push(stamp);
            requestAnimationFrame(() => stamp.classList.add('pop'));
        }

        function undoStamp() {
            if (stampHistory.length > 0) {
                const last = stampHistory.pop();
                redoStack.push(last); 
                if (document.body.contains(last)) last.style.display = 'none';
            }
        }

        function redoStamp() {
            if (redoStack.length > 0) {
                const next = redoStack.pop();
                stampHistory.push(next);
                next.style.display = 'block'; 
                requestAnimationFrame(() => next.classList.add('pop'));
            }
        }

        function exportColors() {
            const stamps = Array.from(document.querySelectorAll('.stamp')).filter(s => s.style.display !== 'none');
            if (stamps.length === 0) return;

            let text = "My Color Palette:\n";
            stamps.forEach((s, index) => {
                text += `Color ${index + 1}: ${s.getAttribute('data-hex')}\n`;
            });

            navigator.clipboard.writeText(text).then(() => {
                const bar = document.getElementById('command-bar');
                const input = document.getElementById('cmd-input');
                bar.style.backgroundColor = '#004433'; 
                input.value = "COPIED TO CLIPBOARD!";
                setTimeout(() => {
                    bar.style.backgroundColor = '#000';
                    input.value = "";
                }, 1500);
            });
        }

        function playPalette(colors) {
            isAutoPlaying = true;
            let i = 0;
            function next() {
                if (i >= colors.length) { isAutoPlaying = false; return; }
                const target = colors[i];
                hue = target.h; light = target.l; sat = target.s;
                const pos = dataToPos(hue, light);
                hairX.style.transition = 'top 0.3s ease-out';
                hairY.style.transition = 'left 0.3s ease-out';
                render();
                setTimeout(() => {
                    createStamp(hue, light, sat);
                    i++;
                    setTimeout(next, 200); 
                }, 150);
            }
            hairX.style.transition = 'none'; hairY.style.transition = 'none';
            next();
        }
    </script>
</body>
</html>
